{% extends "base.html" %}

{% block content %}
<header>
    <h1>Text to Storyteller</h1>
    <p class="subtitle">Transform your adventure modules into narrated audio</p>
</header>

<main>
    {% if flash_message %}
    <div class="flash-banner" id="flash-banner">
        <span>{{ flash_message }}</span>
        <button class="btn-clear" onclick="this.parentElement.hidden=true">&times;</button>
    </div>
    {% endif %}

    <!-- Input Tabs -->
    <div class="tabs">
        <button class="tab active" data-tab="upload">Upload File</button>
        <button class="tab" data-tab="paste">Paste Text</button>
    </div>

    <!-- Upload Tab -->
    <div class="tab-content active" id="tab-upload">
        <div class="drop-zone" id="drop-zone">
            <div class="drop-zone-inner">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17 8 12 3 7 8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                <p>Drag &amp; drop a Markdown file here</p>
                <p class="drop-zone-hint">or click to browse (.md, .txt, .markdown)</p>
                <input type="file" id="file-input" accept=".md,.txt,.markdown" hidden>
            </div>
            <div class="file-selected" id="file-selected" hidden>
                <span id="file-name"></span>
                <button class="btn-clear" id="clear-file">&times;</button>
            </div>
        </div>
    </div>

    <!-- Paste Tab -->
    <div class="tab-content" id="tab-paste">
        <textarea id="text-input" placeholder="Paste your adventure module text here..." rows="14"></textarea>
    </div>

    <!-- Voice Settings -->
    <details class="settings-panel">
        <summary>Voice Settings</summary>
        <div class="settings-grid">
            <!-- Presets -->
            <div class="setting setting-voice">
                <label>Preset</label>
                <div class="preset-row">
                    <select id="preset-select">
                        <option value="">Custom settings</option>
                    </select>
                    <button class="btn-small" id="btn-save-preset" title="Save current settings as preset">Save</button>
                    <button class="btn-small btn-danger" id="btn-delete-preset" title="Delete selected preset" hidden>Delete</button>
                </div>
            </div>

            <!-- Voice -->
            <div class="setting setting-voice">
                <label>Voice</label>
                <div class="voice-category-filters" id="voice-category-filters">
                    <button class="category-chip active" data-category="all">All</button>
                </div>
                <select id="voice-select">
                    <option value="">Loading voices...</option>
                </select>
                <span class="voice-count" id="voice-count"></span>
                <div id="tier-upgrade-note"></div>
            </div>
            <div class="setting">
                <label for="speed-slider">Speed: <span id="speed-value">0.95x</span></label>
                <input type="range" id="speed-slider" min="0.5" max="2.0" step="0.05" value="0.95">
            </div>
            <div class="setting">
                <label for="pitch-slider">Pitch: <span id="pitch-value">-2.0</span></label>
                <input type="range" id="pitch-slider" min="-10.0" max="10.0" step="0.5" value="-2.0">
            </div>
        </div>
    </details>

    <!-- Generation Options -->
    <div class="generation-options">
        <div class="option-row">
            <label for="audio-title">Audio Title</label>
            <input type="text" id="audio-title" placeholder="Untitled" maxlength="200">
        </div>
        <div class="option-row">
            <label class="checkbox-label">
                <input type="checkbox" id="save-text-check">
                Save text to library
            </label>
            <input type="text" id="save-text-title" placeholder="Title for saved text" maxlength="200" hidden>
        </div>
    </div>

    <!-- Source Text Picker (populated via JS if user has saved texts) -->
    <div class="source-text-picker" id="source-text-picker" hidden>
        <select id="source-text-select">
            <option value="">-- Load from My Texts --</option>
        </select>
    </div>

    <!-- Tier Upgrade Banner (populated by JS for free users) -->
    <div id="tier-upgrade-banner"></div>

    <!-- Generate Button -->
    <button class="btn-generate" id="btn-generate">Generate Audio</button>

    <!-- Error Display -->
    <div class="error-banner" id="error-banner" hidden>
        <span id="error-message"></span>
        <button class="btn-clear" id="clear-error">&times;</button>
    </div>

    <!-- Progress Section -->
    <div class="progress-section" id="progress-section" hidden>
        <h3>Generating Audio...</h3>
        <div class="progress-bar-track">
            <div class="progress-bar-fill" id="progress-bar"></div>
        </div>
        <p class="progress-text">
            <span id="progress-chunks">0 / 0</span> chunks
            &mdash; <span id="progress-time">Estimating...</span>
        </p>
    </div>

    <!-- Audio Player Section -->
    <div class="result-section" id="result-section" hidden>
        <h3>Audio Ready!</h3>
        <div class="audio-player">
            <audio id="audio-player" controls preload="auto"></audio>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/app.js') }}"></script>
{% endblock %}
